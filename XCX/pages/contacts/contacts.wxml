<!--pages/contacts/contacts.wxml-->
<view class="page">
  <!-- 顶部统计 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{stats.total}}</view>
        <view class="stat-label">总联系人</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.groups}}</view>
        <view class="stat-label">分组</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.favorites}}</view>
        <view class="stat-label">收藏</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.recent}}</view>
        <view class="stat-label">最近联系</view>
      </view>
    </view>
  </view>

  <!-- 快速操作 -->
  <view class="quick-actions">
    <view class="action-item" bindtap="createContact">
      <view class="action-icon">👤</view>
      <view class="action-text">添加联系人</view>
    </view>
    <view class="action-item" bindtap="importContacts">
      <view class="action-icon">📥</view>
      <view class="action-text">导入</view>
    </view>
    <view class="action-item" bindtap="scanCard">
      <view class="action-icon">📷</view>
      <view class="action-text">扫名片</view>
    </view>
    <view class="action-item" bindtap="manageGroups">
      <view class="action-icon">📁</view>
      <view class="action-text">分组管理</view>
    </view>
  </view>

  <!-- 搜索和筛选 -->
  <view class="search-section">
    <view class="search-bar">
      <input 
        class="search-input" 
        placeholder="搜索联系人" 
        value="{{searchText}}"
        bindinput="onSearchInput"
      />
      <view class="search-icon">🔍</view>
    </view>
    
    <scroll-view class="filter-tabs" scroll-x>
      <view 
        class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
        data-filter="all"
        bindtap="switchFilter"
      >
        全部
      </view>
      <view 
        class="filter-tab {{currentFilter === 'favorites' ? 'active' : ''}}"
        data-filter="favorites"
        bindtap="switchFilter"
      >
        收藏
      </view>
      <view 
        class="filter-tab {{currentFilter === 'recent' ? 'active' : ''}}"
        data-filter="recent"
        bindtap="switchFilter"
      >
        最近联系
      </view>
      <view 
        class="filter-tab {{currentFilter === 'groups' ? 'active' : ''}}"
        data-filter="groups"
        bindtap="switchFilter"
      >
        分组
      </view>
    </scroll-view>
    
    <view class="sort-options">
      <view 
        class="sort-option {{currentSort === 'name' ? 'active' : ''}}"
        data-sort="name"
        bindtap="switchSort"
      >
        姓名
      </view>
      <view 
        class="sort-option {{currentSort === 'recent' ? 'active' : ''}}"
        data-sort="recent"
        bindtap="switchSort"
      >
        最近联系
      </view>
      <view 
        class="sort-option {{currentSort === 'created' ? 'active' : ''}}"
        data-sort="created"
        bindtap="switchSort"
      >
        添加时间
      </view>
    </view>
  </view>

  <!-- 分组列表 (当筛选为分组时显示) -->
  <view class="groups-section" wx:if="{{currentFilter === 'groups'}}">
    <view 
      class="group-item"
      wx:for="{{groups}}"
      wx:key="id"
      data-group="{{item}}"
      bindtap="openGroup"
    >
      <view class="group-icon">{{item.icon}}</view>
      <view class="group-info">
        <view class="group-name">{{item.name}}</view>
        <view class="group-count">{{item.count}}人</view>
      </view>
      <view class="group-arrow">›</view>
    </view>
  </view>

  <!-- 联系人列表 -->
  <view class="contacts-section" wx:else>
    <!-- 字母索引 -->
    <view class="alphabet-index" wx:if="{{currentSort === 'name' && !searchText}}">
      <view 
        class="alphabet-item {{currentAlphabet === item ? 'active' : ''}}"
        wx:for="{{alphabetList}}"
        wx:key="*this"
        data-alphabet="{{item}}"
        bindtap="jumpToAlphabet"
      >
        {{item}}
      </view>
    </view>

    <!-- 联系人列表 -->
    <view class="contacts-list">
      <block wx:if="{{currentSort === 'name' && !searchText}}">
        <view 
          class="alphabet-section"
          wx:for="{{groupedContacts}}"
          wx:key="letter"
          id="alphabet-{{item.letter}}"
        >
          <view class="alphabet-header">{{item.letter}}</view>
          <view 
            class="contact-item"
            wx:for="{{item.contacts}}"
            wx:for-item="contact"
            wx:key="id"
            data-contact="{{contact}}"
            bindtap="openContact"
            bindlongpress="showContactOptions"
          >
            <view class="contact-avatar">
              <image 
                wx:if="{{contact.avatar}}"
                class="avatar-image"
                src="{{contact.avatar}}"
                mode="aspectFill"
              />
              <view wx:else class="avatar-text">{{contact.nameInitial}}</view>
            </view>
            <view class="contact-info">
              <view class="contact-name">
                {{contact.name}}
                <view class="favorite-icon" wx:if="{{contact.isFavorite}}">⭐</view>
              </view>
              <view class="contact-detail">
                <text wx:if="{{contact.company}}">{{contact.company}}</text>
                <text wx:if="{{contact.position && contact.company}}"> · </text>
                <text wx:if="{{contact.position}}">{{contact.position}}</text>
              </view>
            </view>
            <view class="contact-actions">
              <view class="contact-phone" wx:if="{{contact.phone}}" data-phone="{{contact.phone}}" bindtap="callContact" catchtap="preventBubble">
                📞
              </view>
              <view class="contact-message" data-contact="{{contact}}" bindtap="messageContact" catchtap="preventBubble">
                💬
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <block wx:else>
        <view 
          class="contact-item"
          wx:for="{{filteredContacts}}"
          wx:key="id"
          data-contact="{{item}}"
          bindtap="openContact"
          bindlongpress="showContactOptions"
        >
          <view class="contact-avatar">
            <image 
              wx:if="{{item.avatar}}"
              class="avatar-image"
              src="{{item.avatar}}"
              mode="aspectFill"
            />
            <view wx:else class="avatar-text">{{item.nameInitial}}</view>
          </view>
          <view class="contact-info">
            <view class="contact-name">
              {{item.name}}
              <view class="favorite-icon" wx:if="{{item.isFavorite}}">⭐</view>
            </view>
            <view class="contact-detail">
              <text wx:if="{{item.company}}">{{item.company}}</text>
              <text wx:if="{{item.position && item.company}}"> · </text>
              <text wx:if="{{item.position}}">{{item.position}}</text>
            </view>
            <view class="contact-tags" wx:if="{{item.tags && item.tags.length}}">
              <view class="contact-tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">
                {{tag}}
              </view>
            </view>
          </view>
          <view class="contact-actions">
            <view class="contact-phone" wx:if="{{item.phone}}" data-phone="{{item.phone}}" bindtap="callContact" catchtap="preventBubble">
              📞
            </view>
            <view class="contact-message" data-contact="{{item}}" bindtap="messageContact" catchtap="preventBubble">
              💬
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{filteredContacts.length === 0 && groupedContacts.length === 0}}">
      <view class="empty-icon">👥</view>
      <view class="empty-text">{{emptyText}}</view>
      <view class="empty-action" bindtap="createContact" wx:if="{{!searchText}}">
        添加第一个联系人
      </view>
    </view>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab" bindtap="createContact">
    <view class="fab-icon">+</view>
  </view>
</view>

<!-- 联系人创建/编辑弹窗 -->
<view class="modal-overlay" wx:if="{{showContactModal}}" bindtap="hideContactModal">
  <view class="modal-content contact-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">{{editingContact.id ? '编辑联系人' : '添加联系人'}}</view>
      <view class="modal-close" bindtap="hideContactModal">×</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y>
      <!-- 头像 -->
      <view class="form-section">
        <view class="avatar-upload" bindtap="selectAvatar">
          <image 
            wx:if="{{editingContact.avatar}}"
            class="avatar-preview"
            src="{{editingContact.avatar}}"
            mode="aspectFill"
          />
          <view wx:else class="avatar-placeholder">
            <view class="avatar-icon">📷</view>
            <view class="avatar-text">添加头像</view>
          </view>
        </view>
      </view>
      
      <!-- 基本信息 -->
      <view class="form-section">
        <view class="form-title">基本信息</view>
        <view class="form-item">
          <view class="form-label">姓名 *</view>
          <input 
            class="form-input"
            placeholder="请输入姓名"
            value="{{editingContact.name}}"
            bindinput="onNameInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">手机号</view>
          <input 
            class="form-input"
            placeholder="请输入手机号"
            value="{{editingContact.phone}}"
            bindinput="onPhoneInput"
            type="number"
          />
        </view>
        <view class="form-item">
          <view class="form-label">邮箱</view>
          <input 
            class="form-input"
            placeholder="请输入邮箱"
            value="{{editingContact.email}}"
            bindinput="onEmailInput"
          />
        </view>
      </view>
      
      <!-- 工作信息 -->
      <view class="form-section">
        <view class="form-title">工作信息</view>
        <view class="form-item">
          <view class="form-label">公司</view>
          <input 
            class="form-input"
            placeholder="请输入公司名称"
            value="{{editingContact.company}}"
            bindinput="onCompanyInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">职位</view>
          <input 
            class="form-input"
            placeholder="请输入职位"
            value="{{editingContact.position}}"
            bindinput="onPositionInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">部门</view>
          <input 
            class="form-input"
            placeholder="请输入部门"
            value="{{editingContact.department}}"
            bindinput="onDepartmentInput"
          />
        </view>
      </view>
      
      <!-- 分组 -->
      <view class="form-section">
        <view class="form-title">分组</view>
        <view class="form-item">
          <picker 
            class="form-picker"
            range="{{groupOptions}}"
            range-key="name"
            value="{{editingContact.groupIndex}}"
            bindchange="onGroupChange"
          >
            <view class="picker-text {{editingContact.groupIndex === -1 ? 'placeholder' : ''}}">
              {{editingContact.groupIndex === -1 ? '选择分组' : groupOptions[editingContact.groupIndex].name}}
            </view>
            <view class="picker-arrow">›</view>
          </picker>
        </view>
      </view>
      
      <!-- 标签 -->
      <view class="form-section">
        <view class="form-title">标签</view>
        <view class="tags-input">
          <view class="tag-item" wx:for="{{editingContact.tags}}" wx:key="*this">
            <text>{{item}}</text>
            <view class="tag-remove" data-tag="{{item}}" bindtap="removeTag">×</view>
          </view>
          <input 
            class="tag-input"
            placeholder="添加标签"
            value="{{inputTag}}"
            bindinput="onTagInput"
            bindconfirm="addTag"
          />
        </view>
      </view>
      
      <!-- 备注 -->
      <view class="form-section">
        <view class="form-title">备注</view>
        <view class="form-item">
          <textarea 
            class="form-textarea"
            placeholder="添加备注信息"
            value="{{editingContact.notes}}"
            bindinput="onNotesInput"
            maxlength="500"
          />
        </view>
      </view>
      
      <!-- 设置 -->
      <view class="form-section">
        <view class="form-title">设置</view>
        <view class="form-item form-switch">
          <view class="form-label">添加到收藏</view>
          <switch 
            checked="{{editingContact.isFavorite}}"
            bindchange="onFavoriteChange"
            color="#007AFF"
          />
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideContactModal">取消</view>
      <view class="btn btn-primary" bindtap="saveContact">保存</view>
    </view>
  </view>
</view>

<!-- 联系人操作弹窗 -->
<view class="modal-overlay" wx:if="{{showContactOptions}}" bindtap="hideContactOptions">
  <view class="modal-content options-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">联系人操作</view>
      <view class="modal-close" bindtap="hideContactOptions">×</view>
    </view>
    
    <view class="options-list">
      <view class="option-item" bindtap="editContact">
        <view class="option-icon">✏️</view>
        <view class="option-text">编辑</view>
      </view>
      <view class="option-item" bindtap="toggleFavorite">
        <view class="option-icon">{{selectedContact.isFavorite ? '⭐' : '☆'}}</view>
        <view class="option-text">{{selectedContact.isFavorite ? '取消收藏' : '添加收藏'}}</view>
      </view>
      <view class="option-item" bindtap="shareContact">
        <view class="option-icon">📤</view>
        <view class="option-text">分享名片</view>
      </view>
      <view class="option-item" bindtap="duplicateContact">
        <view class="option-icon">📋</view>
        <view class="option-text">复制联系人</view>
      </view>
      <view class="option-item danger" bindtap="deleteContact">
        <view class="option-icon">🗑️</view>
        <view class="option-text">删除</view>
      </view>
    </view>
  </view>
</view>

<!-- 联系人详情弹窗 -->
<view class="modal-overlay" wx:if="{{showContactDetail}}" bindtap="hideContactDetail">
  <view class="modal-content detail-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">联系人详情</view>
      <view class="modal-close" bindtap="hideContactDetail">×</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y>
      <!-- 头像和基本信息 -->
      <view class="detail-header">
        <view class="detail-avatar">
          <image 
            wx:if="{{selectedContact.avatar}}"
            class="avatar-image"
            src="{{selectedContact.avatar}}"
            mode="aspectFill"
          />
          <view wx:else class="avatar-text">{{selectedContact.nameInitial}}</view>
        </view>
        <view class="detail-info">
          <view class="detail-name">
            {{selectedContact.name}}
            <view class="favorite-icon" wx:if="{{selectedContact.isFavorite}}">⭐</view>
          </view>
          <view class="detail-company" wx:if="{{selectedContact.company || selectedContact.position}}">
            <text wx:if="{{selectedContact.company}}">{{selectedContact.company}}</text>
            <text wx:if="{{selectedContact.position && selectedContact.company}}"> · </text>
            <text wx:if="{{selectedContact.position}}">{{selectedContact.position}}</text>
          </view>
        </view>
      </view>
      
      <!-- 联系方式 -->
      <view class="detail-section" wx:if="{{selectedContact.phone || selectedContact.email}}">
        <view class="section-title">联系方式</view>
        <view class="contact-method" wx:if="{{selectedContact.phone}}">
          <view class="method-icon">📞</view>
          <view class="method-info">
            <view class="method-label">手机号</view>
            <view class="method-value">{{selectedContact.phone}}</view>
          </view>
          <view class="method-actions">
            <view class="method-action" data-phone="{{selectedContact.phone}}" bindtap="callContact">
              拨打
            </view>
            <view class="method-action" data-contact="{{selectedContact}}" bindtap="messageContact">
              短信
            </view>
          </view>
        </view>
        <view class="contact-method" wx:if="{{selectedContact.email}}">
          <view class="method-icon">📧</view>
          <view class="method-info">
            <view class="method-label">邮箱</view>
            <view class="method-value">{{selectedContact.email}}</view>
          </view>
          <view class="method-actions">
            <view class="method-action" data-email="{{selectedContact.email}}" bindtap="emailContact">
              发邮件
            </view>
          </view>
        </view>
      </view>
      
      <!-- 工作信息 -->
      <view class="detail-section" wx:if="{{selectedContact.company || selectedContact.position || selectedContact.department}}">
        <view class="section-title">工作信息</view>
        <view class="info-item" wx:if="{{selectedContact.company}}">
          <view class="info-label">公司</view>
          <view class="info-value">{{selectedContact.company}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.position}}">
          <view class="info-label">职位</view>
          <view class="info-value">{{selectedContact.position}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.department}}">
          <view class="info-label">部门</view>
          <view class="info-value">{{selectedContact.department}}</view>
        </view>
      </view>
      
      <!-- 标签 -->
      <view class="detail-section" wx:if="{{selectedContact.tags && selectedContact.tags.length}}">
        <view class="section-title">标签</view>
        <view class="detail-tags">
          <view class="detail-tag" wx:for="{{selectedContact.tags}}" wx:key="*this">
            {{item}}
          </view>
        </view>
      </view>
      
      <!-- 备注 -->
      <view class="detail-section" wx:if="{{selectedContact.notes}}">
        <view class="section-title">备注</view>
        <view class="detail-notes">{{selectedContact.notes}}</view>
      </view>
      
      <!-- 其他信息 -->
      <view class="detail-section">
        <view class="section-title">其他信息</view>
        <view class="info-item">
          <view class="info-label">分组</view>
          <view class="info-value">{{selectedContact.groupName || '未分组'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">添加时间</view>
          <view class="info-value">{{selectedContact.createdAtText}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.lastContactTime}}">
          <view class="info-label">最近联系</view>
          <view class="info-value">{{selectedContact.lastContactTimeText}}</view>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideContactDetail">关闭</view>
      <view class="btn btn-primary" bindtap="editFromDetail">编辑</view>
    </view>
  </view>
</view>

<!-- 分组管理弹窗 -->
<view class="modal-overlay" wx:if="{{showGroupModal}}" bindtap="hideGroupModal">
  <view class="modal-content group-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">分组管理</view>
      <view class="modal-close" bindtap="hideGroupModal">×</view>
    </view>
    
    <view class="modal-body">
      <!-- 添加分组 -->
      <view class="add-group-section">
        <view class="form-item">
          <input 
            class="form-input"
            placeholder="输入分组名称"
            value="{{newGroupName}}"
            bindinput="onNewGroupNameInput"
          />
          <view class="btn btn-small btn-primary" bindtap="addGroup">添加</view>
        </view>
      </view>
      
      <!-- 分组列表 -->
      <view class="groups-list">
        <view 
          class="group-item"
          wx:for="{{groups}}"
          wx:key="id"
        >
          <view class="group-icon">{{item.icon}}</view>
          <view class="group-info">
            <view class="group-name">{{item.name}}</view>
            <view class="group-count">{{item.count}}人</view>
          </view>
          <view class="group-actions">
            <view class="group-action" data-group="{{item}}" bindtap="editGroup">编辑</view>
            <view class="group-action danger" data-group="{{item}}" bindtap="deleteGroup" wx:if="{{!item.isDefault}}">删除</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>