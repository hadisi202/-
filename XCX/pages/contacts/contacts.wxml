<!--pages/contacts/contacts.wxml-->
<view class="page">
  <!-- é¡¶éƒ¨ç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{stats.total}}</view>
        <view class="stat-label">æ€»è”ç³»äºº</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.groups}}</view>
        <view class="stat-label">åˆ†ç»„</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.favorites}}</view>
        <view class="stat-label">æ”¶è—</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{stats.recent}}</view>
        <view class="stat-label">æœ€è¿‘è”ç³»</view>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œ -->
  <view class="quick-actions">
    <view class="action-item" bindtap="createContact">
      <view class="action-icon">ğŸ‘¤</view>
      <view class="action-text">æ·»åŠ è”ç³»äºº</view>
    </view>
    <view class="action-item" bindtap="importContacts">
      <view class="action-icon">ğŸ“¥</view>
      <view class="action-text">å¯¼å…¥</view>
    </view>
    <view class="action-item" bindtap="scanCard">
      <view class="action-icon">ğŸ“·</view>
      <view class="action-text">æ‰«åç‰‡</view>
    </view>
    <view class="action-item" bindtap="manageGroups">
      <view class="action-icon">ğŸ“</view>
      <view class="action-text">åˆ†ç»„ç®¡ç†</view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <view class="search-bar">
      <input 
        class="search-input" 
        placeholder="æœç´¢è”ç³»äºº" 
        value="{{searchText}}"
        bindinput="onSearchInput"
      />
      <view class="search-icon">ğŸ”</view>
    </view>
    
    <scroll-view class="filter-tabs" scroll-x>
      <view 
        class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
        data-filter="all"
        bindtap="switchFilter"
      >
        å…¨éƒ¨
      </view>
      <view 
        class="filter-tab {{currentFilter === 'favorites' ? 'active' : ''}}"
        data-filter="favorites"
        bindtap="switchFilter"
      >
        æ”¶è—
      </view>
      <view 
        class="filter-tab {{currentFilter === 'recent' ? 'active' : ''}}"
        data-filter="recent"
        bindtap="switchFilter"
      >
        æœ€è¿‘è”ç³»
      </view>
      <view 
        class="filter-tab {{currentFilter === 'groups' ? 'active' : ''}}"
        data-filter="groups"
        bindtap="switchFilter"
      >
        åˆ†ç»„
      </view>
    </scroll-view>
    
    <view class="sort-options">
      <view 
        class="sort-option {{currentSort === 'name' ? 'active' : ''}}"
        data-sort="name"
        bindtap="switchSort"
      >
        å§“å
      </view>
      <view 
        class="sort-option {{currentSort === 'recent' ? 'active' : ''}}"
        data-sort="recent"
        bindtap="switchSort"
      >
        æœ€è¿‘è”ç³»
      </view>
      <view 
        class="sort-option {{currentSort === 'created' ? 'active' : ''}}"
        data-sort="created"
        bindtap="switchSort"
      >
        æ·»åŠ æ—¶é—´
      </view>
    </view>
  </view>

  <!-- åˆ†ç»„åˆ—è¡¨ (å½“ç­›é€‰ä¸ºåˆ†ç»„æ—¶æ˜¾ç¤º) -->
  <view class="groups-section" wx:if="{{currentFilter === 'groups'}}">
    <view 
      class="group-item"
      wx:for="{{groups}}"
      wx:key="id"
      data-group="{{item}}"
      bindtap="openGroup"
    >
      <view class="group-icon">{{item.icon}}</view>
      <view class="group-info">
        <view class="group-name">{{item.name}}</view>
        <view class="group-count">{{item.count}}äºº</view>
      </view>
      <view class="group-arrow">â€º</view>
    </view>
  </view>

  <!-- è”ç³»äººåˆ—è¡¨ -->
  <view class="contacts-section" wx:else>
    <!-- å­—æ¯ç´¢å¼• -->
    <view class="alphabet-index" wx:if="{{currentSort === 'name' && !searchText}}">
      <view 
        class="alphabet-item {{currentAlphabet === item ? 'active' : ''}}"
        wx:for="{{alphabetList}}"
        wx:key="*this"
        data-alphabet="{{item}}"
        bindtap="jumpToAlphabet"
      >
        {{item}}
      </view>
    </view>

    <!-- è”ç³»äººåˆ—è¡¨ -->
    <view class="contacts-list">
      <block wx:if="{{currentSort === 'name' && !searchText}}">
        <view 
          class="alphabet-section"
          wx:for="{{groupedContacts}}"
          wx:key="letter"
          id="alphabet-{{item.letter}}"
        >
          <view class="alphabet-header">{{item.letter}}</view>
          <view 
            class="contact-item"
            wx:for="{{item.contacts}}"
            wx:for-item="contact"
            wx:key="id"
            data-contact="{{contact}}"
            bindtap="openContact"
            bindlongpress="showContactOptions"
          >
            <view class="contact-avatar">
              <image 
                wx:if="{{contact.avatar}}"
                class="avatar-image"
                src="{{contact.avatar}}"
                mode="aspectFill"
              />
              <view wx:else class="avatar-text">{{contact.nameInitial}}</view>
            </view>
            <view class="contact-info">
              <view class="contact-name">
                {{contact.name}}
                <view class="favorite-icon" wx:if="{{contact.isFavorite}}">â­</view>
              </view>
              <view class="contact-detail">
                <text wx:if="{{contact.company}}">{{contact.company}}</text>
                <text wx:if="{{contact.position && contact.company}}"> Â· </text>
                <text wx:if="{{contact.position}}">{{contact.position}}</text>
              </view>
            </view>
            <view class="contact-actions">
              <view class="contact-phone" wx:if="{{contact.phone}}" data-phone="{{contact.phone}}" bindtap="callContact" catchtap="preventBubble">
                ğŸ“
              </view>
              <view class="contact-message" data-contact="{{contact}}" bindtap="messageContact" catchtap="preventBubble">
                ğŸ’¬
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <block wx:else>
        <view 
          class="contact-item"
          wx:for="{{filteredContacts}}"
          wx:key="id"
          data-contact="{{item}}"
          bindtap="openContact"
          bindlongpress="showContactOptions"
        >
          <view class="contact-avatar">
            <image 
              wx:if="{{item.avatar}}"
              class="avatar-image"
              src="{{item.avatar}}"
              mode="aspectFill"
            />
            <view wx:else class="avatar-text">{{item.nameInitial}}</view>
          </view>
          <view class="contact-info">
            <view class="contact-name">
              {{item.name}}
              <view class="favorite-icon" wx:if="{{item.isFavorite}}">â­</view>
            </view>
            <view class="contact-detail">
              <text wx:if="{{item.company}}">{{item.company}}</text>
              <text wx:if="{{item.position && item.company}}"> Â· </text>
              <text wx:if="{{item.position}}">{{item.position}}</text>
            </view>
            <view class="contact-tags" wx:if="{{item.tags && item.tags.length}}">
              <view class="contact-tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">
                {{tag}}
              </view>
            </view>
          </view>
          <view class="contact-actions">
            <view class="contact-phone" wx:if="{{item.phone}}" data-phone="{{item.phone}}" bindtap="callContact" catchtap="preventBubble">
              ğŸ“
            </view>
            <view class="contact-message" data-contact="{{item}}" bindtap="messageContact" catchtap="preventBubble">
              ğŸ’¬
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{filteredContacts.length === 0 && groupedContacts.length === 0}}">
      <view class="empty-icon">ğŸ‘¥</view>
      <view class="empty-text">{{emptyText}}</view>
      <view class="empty-action" bindtap="createContact" wx:if="{{!searchText}}">
        æ·»åŠ ç¬¬ä¸€ä¸ªè”ç³»äºº
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab" bindtap="createContact">
    <view class="fab-icon">+</view>
  </view>
</view>

<!-- è”ç³»äººåˆ›å»º/ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showContactModal}}" bindtap="hideContactModal">
  <view class="modal-content contact-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">{{editingContact.id ? 'ç¼–è¾‘è”ç³»äºº' : 'æ·»åŠ è”ç³»äºº'}}</view>
      <view class="modal-close" bindtap="hideContactModal">Ã—</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y>
      <!-- å¤´åƒ -->
      <view class="form-section">
        <view class="avatar-upload" bindtap="selectAvatar">
          <image 
            wx:if="{{editingContact.avatar}}"
            class="avatar-preview"
            src="{{editingContact.avatar}}"
            mode="aspectFill"
          />
          <view wx:else class="avatar-placeholder">
            <view class="avatar-icon">ğŸ“·</view>
            <view class="avatar-text">æ·»åŠ å¤´åƒ</view>
          </view>
        </view>
      </view>
      
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section">
        <view class="form-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="form-item">
          <view class="form-label">å§“å *</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥å§“å"
            value="{{editingContact.name}}"
            bindinput="onNameInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">æ‰‹æœºå·</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
            value="{{editingContact.phone}}"
            bindinput="onPhoneInput"
            type="number"
          />
        </view>
        <view class="form-item">
          <view class="form-label">é‚®ç®±</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥é‚®ç®±"
            value="{{editingContact.email}}"
            bindinput="onEmailInput"
          />
        </view>
      </view>
      
      <!-- å·¥ä½œä¿¡æ¯ -->
      <view class="form-section">
        <view class="form-title">å·¥ä½œä¿¡æ¯</view>
        <view class="form-item">
          <view class="form-label">å…¬å¸</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥å…¬å¸åç§°"
            value="{{editingContact.company}}"
            bindinput="onCompanyInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">èŒä½</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥èŒä½"
            value="{{editingContact.position}}"
            bindinput="onPositionInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">éƒ¨é—¨</view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥éƒ¨é—¨"
            value="{{editingContact.department}}"
            bindinput="onDepartmentInput"
          />
        </view>
      </view>
      
      <!-- åˆ†ç»„ -->
      <view class="form-section">
        <view class="form-title">åˆ†ç»„</view>
        <view class="form-item">
          <picker 
            class="form-picker"
            range="{{groupOptions}}"
            range-key="name"
            value="{{editingContact.groupIndex}}"
            bindchange="onGroupChange"
          >
            <view class="picker-text {{editingContact.groupIndex === -1 ? 'placeholder' : ''}}">
              {{editingContact.groupIndex === -1 ? 'é€‰æ‹©åˆ†ç»„' : groupOptions[editingContact.groupIndex].name}}
            </view>
            <view class="picker-arrow">â€º</view>
          </picker>
        </view>
      </view>
      
      <!-- æ ‡ç­¾ -->
      <view class="form-section">
        <view class="form-title">æ ‡ç­¾</view>
        <view class="tags-input">
          <view class="tag-item" wx:for="{{editingContact.tags}}" wx:key="*this">
            <text>{{item}}</text>
            <view class="tag-remove" data-tag="{{item}}" bindtap="removeTag">Ã—</view>
          </view>
          <input 
            class="tag-input"
            placeholder="æ·»åŠ æ ‡ç­¾"
            value="{{inputTag}}"
            bindinput="onTagInput"
            bindconfirm="addTag"
          />
        </view>
      </view>
      
      <!-- å¤‡æ³¨ -->
      <view class="form-section">
        <view class="form-title">å¤‡æ³¨</view>
        <view class="form-item">
          <textarea 
            class="form-textarea"
            placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯"
            value="{{editingContact.notes}}"
            bindinput="onNotesInput"
            maxlength="500"
          />
        </view>
      </view>
      
      <!-- è®¾ç½® -->
      <view class="form-section">
        <view class="form-title">è®¾ç½®</view>
        <view class="form-item form-switch">
          <view class="form-label">æ·»åŠ åˆ°æ”¶è—</view>
          <switch 
            checked="{{editingContact.isFavorite}}"
            bindchange="onFavoriteChange"
            color="#007AFF"
          />
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideContactModal">å–æ¶ˆ</view>
      <view class="btn btn-primary" bindtap="saveContact">ä¿å­˜</view>
    </view>
  </view>
</view>

<!-- è”ç³»äººæ“ä½œå¼¹çª— -->
<view class="modal-overlay" wx:if="{{showContactOptions}}" bindtap="hideContactOptions">
  <view class="modal-content options-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">è”ç³»äººæ“ä½œ</view>
      <view class="modal-close" bindtap="hideContactOptions">Ã—</view>
    </view>
    
    <view class="options-list">
      <view class="option-item" bindtap="editContact">
        <view class="option-icon">âœï¸</view>
        <view class="option-text">ç¼–è¾‘</view>
      </view>
      <view class="option-item" bindtap="toggleFavorite">
        <view class="option-icon">{{selectedContact.isFavorite ? 'â­' : 'â˜†'}}</view>
        <view class="option-text">{{selectedContact.isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ·»åŠ æ”¶è—'}}</view>
      </view>
      <view class="option-item" bindtap="shareContact">
        <view class="option-icon">ğŸ“¤</view>
        <view class="option-text">åˆ†äº«åç‰‡</view>
      </view>
      <view class="option-item" bindtap="duplicateContact">
        <view class="option-icon">ğŸ“‹</view>
        <view class="option-text">å¤åˆ¶è”ç³»äºº</view>
      </view>
      <view class="option-item danger" bindtap="deleteContact">
        <view class="option-icon">ğŸ—‘ï¸</view>
        <view class="option-text">åˆ é™¤</view>
      </view>
    </view>
  </view>
</view>

<!-- è”ç³»äººè¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showContactDetail}}" bindtap="hideContactDetail">
  <view class="modal-content detail-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">è”ç³»äººè¯¦æƒ…</view>
      <view class="modal-close" bindtap="hideContactDetail">Ã—</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y>
      <!-- å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-header">
        <view class="detail-avatar">
          <image 
            wx:if="{{selectedContact.avatar}}"
            class="avatar-image"
            src="{{selectedContact.avatar}}"
            mode="aspectFill"
          />
          <view wx:else class="avatar-text">{{selectedContact.nameInitial}}</view>
        </view>
        <view class="detail-info">
          <view class="detail-name">
            {{selectedContact.name}}
            <view class="favorite-icon" wx:if="{{selectedContact.isFavorite}}">â­</view>
          </view>
          <view class="detail-company" wx:if="{{selectedContact.company || selectedContact.position}}">
            <text wx:if="{{selectedContact.company}}">{{selectedContact.company}}</text>
            <text wx:if="{{selectedContact.position && selectedContact.company}}"> Â· </text>
            <text wx:if="{{selectedContact.position}}">{{selectedContact.position}}</text>
          </view>
        </view>
      </view>
      
      <!-- è”ç³»æ–¹å¼ -->
      <view class="detail-section" wx:if="{{selectedContact.phone || selectedContact.email}}">
        <view class="section-title">è”ç³»æ–¹å¼</view>
        <view class="contact-method" wx:if="{{selectedContact.phone}}">
          <view class="method-icon">ğŸ“</view>
          <view class="method-info">
            <view class="method-label">æ‰‹æœºå·</view>
            <view class="method-value">{{selectedContact.phone}}</view>
          </view>
          <view class="method-actions">
            <view class="method-action" data-phone="{{selectedContact.phone}}" bindtap="callContact">
              æ‹¨æ‰“
            </view>
            <view class="method-action" data-contact="{{selectedContact}}" bindtap="messageContact">
              çŸ­ä¿¡
            </view>
          </view>
        </view>
        <view class="contact-method" wx:if="{{selectedContact.email}}">
          <view class="method-icon">ğŸ“§</view>
          <view class="method-info">
            <view class="method-label">é‚®ç®±</view>
            <view class="method-value">{{selectedContact.email}}</view>
          </view>
          <view class="method-actions">
            <view class="method-action" data-email="{{selectedContact.email}}" bindtap="emailContact">
              å‘é‚®ä»¶
            </view>
          </view>
        </view>
      </view>
      
      <!-- å·¥ä½œä¿¡æ¯ -->
      <view class="detail-section" wx:if="{{selectedContact.company || selectedContact.position || selectedContact.department}}">
        <view class="section-title">å·¥ä½œä¿¡æ¯</view>
        <view class="info-item" wx:if="{{selectedContact.company}}">
          <view class="info-label">å…¬å¸</view>
          <view class="info-value">{{selectedContact.company}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.position}}">
          <view class="info-label">èŒä½</view>
          <view class="info-value">{{selectedContact.position}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.department}}">
          <view class="info-label">éƒ¨é—¨</view>
          <view class="info-value">{{selectedContact.department}}</view>
        </view>
      </view>
      
      <!-- æ ‡ç­¾ -->
      <view class="detail-section" wx:if="{{selectedContact.tags && selectedContact.tags.length}}">
        <view class="section-title">æ ‡ç­¾</view>
        <view class="detail-tags">
          <view class="detail-tag" wx:for="{{selectedContact.tags}}" wx:key="*this">
            {{item}}
          </view>
        </view>
      </view>
      
      <!-- å¤‡æ³¨ -->
      <view class="detail-section" wx:if="{{selectedContact.notes}}">
        <view class="section-title">å¤‡æ³¨</view>
        <view class="detail-notes">{{selectedContact.notes}}</view>
      </view>
      
      <!-- å…¶ä»–ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="section-title">å…¶ä»–ä¿¡æ¯</view>
        <view class="info-item">
          <view class="info-label">åˆ†ç»„</view>
          <view class="info-value">{{selectedContact.groupName || 'æœªåˆ†ç»„'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">æ·»åŠ æ—¶é—´</view>
          <view class="info-value">{{selectedContact.createdAtText}}</view>
        </view>
        <view class="info-item" wx:if="{{selectedContact.lastContactTime}}">
          <view class="info-label">æœ€è¿‘è”ç³»</view>
          <view class="info-value">{{selectedContact.lastContactTimeText}}</view>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideContactDetail">å…³é—­</view>
      <view class="btn btn-primary" bindtap="editFromDetail">ç¼–è¾‘</view>
    </view>
  </view>
</view>

<!-- åˆ†ç»„ç®¡ç†å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showGroupModal}}" bindtap="hideGroupModal">
  <view class="modal-content group-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">åˆ†ç»„ç®¡ç†</view>
      <view class="modal-close" bindtap="hideGroupModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <!-- æ·»åŠ åˆ†ç»„ -->
      <view class="add-group-section">
        <view class="form-item">
          <input 
            class="form-input"
            placeholder="è¾“å…¥åˆ†ç»„åç§°"
            value="{{newGroupName}}"
            bindinput="onNewGroupNameInput"
          />
          <view class="btn btn-small btn-primary" bindtap="addGroup">æ·»åŠ </view>
        </view>
      </view>
      
      <!-- åˆ†ç»„åˆ—è¡¨ -->
      <view class="groups-list">
        <view 
          class="group-item"
          wx:for="{{groups}}"
          wx:key="id"
        >
          <view class="group-icon">{{item.icon}}</view>
          <view class="group-info">
            <view class="group-name">{{item.name}}</view>
            <view class="group-count">{{item.count}}äºº</view>
          </view>
          <view class="group-actions">
            <view class="group-action" data-group="{{item}}" bindtap="editGroup">ç¼–è¾‘</view>
            <view class="group-action danger" data-group="{{item}}" bindtap="deleteGroup" wx:if="{{!item.isDefault}}">åˆ é™¤</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>