<!--pages/todo/todo.wxml-->
<view class="container">
  <!-- 顶部统计区域 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">总计</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.pending}}</text>
        <text class="stat-label">待完成</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.completed}}</text>
        <text class="stat-label">已完成</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.overdue}}</text>
        <text class="stat-label">已逾期</text>
      </view>
    </view>
  </view>

  <!-- 搜索和筛选区域 -->
  <view class="search-section">
    <view class="search-bar">
      <input class="search-input" placeholder="搜索待办事项" value="{{searchText}}" bindinput="onSearchInput" />
      <text class="search-icon">🔍</text>
    </view>
    
    <view class="filter-tabs">
      <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" bindtap="switchFilter" data-filter="all">
        <text>全部</text>
      </view>
      <view class="filter-tab {{currentFilter === 'pending' ? 'active' : ''}}" bindtap="switchFilter" data-filter="pending">
        <text>待完成</text>
      </view>
      <view class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}" bindtap="switchFilter" data-filter="completed">
        <text>已完成</text>
      </view>
      <view class="filter-tab {{currentFilter === 'overdue' ? 'active' : ''}}" bindtap="switchFilter" data-filter="overdue">
        <text>已逾期</text>
      </view>
    </view>
    
    <view class="sort-options">
      <view class="sort-item {{currentSort === 'priority' ? 'active' : ''}}" bindtap="switchSort" data-sort="priority">
        <text>优先级</text>
      </view>
      <view class="sort-item {{currentSort === 'dueDate' ? 'active' : ''}}" bindtap="switchSort" data-sort="dueDate">
        <text>截止时间</text>
      </view>
      <view class="sort-item {{currentSort === 'createdAt' ? 'active' : ''}}" bindtap="switchSort" data-sort="createdAt">
        <text>创建时间</text>
      </view>
    </view>
  </view>

  <!-- 待办列表 -->
  <view class="todo-list" wx:if="{{filteredTodos.length > 0}}">
    <view class="todo-item {{item.completed ? 'completed' : ''}} {{item.priority}}" wx:for="{{filteredTodos}}" wx:key="id">
      <!-- 优先级指示器 -->
      <view class="priority-indicator {{item.priority}}"></view>
      
      <!-- 复选框 -->
      <view class="todo-checkbox {{item.completed ? 'checked' : ''}}" bindtap="toggleTodo" data-id="{{item.id}}">
        <text class="checkbox-icon" wx:if="{{item.completed}}">✓</text>
      </view>
      
      <!-- 待办内容 -->
      <view class="todo-content" bindtap="openTodoDetail" data-item="{{item}}">
        <text class="todo-title {{item.completed ? 'completed' : ''}}">{{item.title}}</text>
        <text class="todo-desc" wx:if="{{item.description}}">{{item.description}}</text>
        
        <!-- 标签 -->
        <view class="todo-tags" wx:if="{{item.tags && item.tags.length > 0}}">
          <text class="todo-tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
        </view>
        
        <!-- 时间信息 -->
        <view class="todo-meta">
          <text class="todo-time" wx:if="{{item.dueDate}}">
            📅 {{item.dueDateText}}
          </text>
          <text class="todo-created">创建于 {{item.createdAtText}}</text>
        </view>
      </view>
      
      <!-- 操作按钮 -->
      <view class="todo-actions">
        <view class="action-btn" bindtap="showTodoOptions" data-item="{{item}}">
          <text class="action-icon">⋯</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">📝</text>
    <text class="empty-text">{{emptyText}}</text>
    <text class="empty-action" bindtap="createTodo" wx:if="{{currentFilter === 'all' || currentFilter === 'pending'}}">创建第一个待办</text>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab" bindtap="createTodo">
    <text class="fab-icon">+</text>
  </view>

  <!-- 待办创建/编辑弹窗 -->
  <view class="modal-overlay" wx:if="{{showTodoModal}}" bindtap="hideTodoModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">{{editingTodo.id ? '编辑待办' : '创建待办'}}</text>
        <text class="modal-close" bindtap="hideTodoModal">✕</text>
      </view>
      
      <view class="modal-body">
        <!-- 标题 -->
        <view class="input-group">
          <text class="input-label">标题 <text class="input-required">*</text></text>
          <input class="input" placeholder="请输入待办标题" value="{{editingTodo.title}}" bindinput="onTitleInput" />
        </view>
        
        <!-- 描述 -->
        <view class="input-group">
          <text class="input-label">描述</text>
          <textarea class="input textarea" placeholder="请输入待办描述" value="{{editingTodo.description}}" bindinput="onDescInput"></textarea>
        </view>
        
        <!-- 优先级 -->
        <view class="input-group">
          <text class="input-label">优先级</text>
          <view class="priority-selector">
            <view class="priority-option {{editingTodo.priority === 'low' ? 'active' : ''}}" bindtap="selectPriority" data-priority="low">
              <view class="priority-dot low"></view>
              <text>低</text>
            </view>
            <view class="priority-option {{editingTodo.priority === 'medium' ? 'active' : ''}}" bindtap="selectPriority" data-priority="medium">
              <view class="priority-dot medium"></view>
              <text>中</text>
            </view>
            <view class="priority-option {{editingTodo.priority === 'high' ? 'active' : ''}}" bindtap="selectPriority" data-priority="high">
              <view class="priority-dot high"></view>
              <text>高</text>
            </view>
          </view>
        </view>
        
        <!-- 截止日期 -->
        <view class="input-group">
          <text class="input-label">截止日期</text>
          <picker mode="date" value="{{editingTodo.dueDate}}" bindchange="onDueDateChange">
            <view class="picker-input">
              <text class="picker-text {{editingTodo.dueDate ? '' : 'placeholder'}}">{{editingTodo.dueDate || '选择截止日期'}}</text>
              <text class="picker-icon">📅</text>
            </view>
          </picker>
        </view>
        
        <!-- 截止时间 -->
        <view class="input-group" wx:if="{{editingTodo.dueDate}}">
          <text class="input-label">截止时间</text>
          <picker mode="time" value="{{editingTodo.dueTime}}" bindchange="onDueTimeChange">
            <view class="picker-input">
              <text class="picker-text {{editingTodo.dueTime ? '' : 'placeholder'}}">{{editingTodo.dueTime || '选择截止时间'}}</text>
              <text class="picker-icon">⏰</text>
            </view>
          </picker>
        </view>
        
        <!-- 标签 -->
        <view class="input-group">
          <text class="input-label">标签</text>
          <view class="tag-input-container">
            <view class="selected-tags" wx:if="{{editingTodo.tags && editingTodo.tags.length > 0}}">
              <view class="selected-tag" wx:for="{{editingTodo.tags}}" wx:key="*this">
                <text>{{item}}</text>
                <text class="tag-remove" bindtap="removeTag" data-tag="{{item}}">×</text>
              </view>
            </view>
            <view class="tag-input-row">
              <input class="tag-input" placeholder="添加标签" value="{{inputTag}}" bindinput="onTagInput" bindconfirm="addTag" />
              <button class="tag-add-btn" bindtap="addTag">添加</button>
            </view>
          </view>
        </view>
        
        <!-- 提醒设置 -->
        <view class="input-group">
          <view class="switch-row">
            <text class="input-label">设置提醒</text>
            <switch checked="{{editingTodo.reminder}}" bindchange="onReminderChange" />
          </view>
          <view class="reminder-options" wx:if="{{editingTodo.reminder}}">
            <picker mode="selector" range="{{reminderOptions}}" value="{{editingTodo.reminderIndex}}" bindchange="onReminderOptionChange">
              <view class="picker-input">
                <text class="picker-text">{{reminderOptions[editingTodo.reminderIndex] || '选择提醒时间'}}</text>
                <text class="picker-icon">⏰</text>
              </view>
            </picker>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideTodoModal">取消</button>
        <button class="btn btn-primary" bindtap="saveTodo">保存</button>
      </view>
    </view>
  </view>

  <!-- 待办操作弹窗 -->
  <view class="action-sheet" wx:if="{{showTodoOptions}}" bindtap="hideTodoOptions">
    <view class="action-sheet-content" catchtap="preventClose">
      <view class="action-sheet-header">
        <text class="action-sheet-title">{{selectedTodo.title}}</text>
        <text class="action-sheet-close" bindtap="hideTodoOptions">✕</text>
      </view>
      <view class="action-list">
        <view class="action-item" bindtap="editTodo">
          <text class="action-icon">✏️</text>
          <text class="action-text">编辑</text>
        </view>
        <view class="action-item" bindtap="duplicateTodo">
          <text class="action-icon">📋</text>
          <text class="action-text">复制</text>
        </view>
        <view class="action-item" bindtap="shareTodo">
          <text class="action-icon">📤</text>
          <text class="action-text">分享</text>
        </view>
        <view class="action-item danger" bindtap="deleteTodo">
          <text class="action-icon">🗑️</text>
          <text class="action-text">删除</text>
        </view>
      </view>
      <view class="action-cancel" bindtap="hideTodoOptions">
        <text>取消</text>
      </view>
    </view>
  </view>

  <!-- 待办详情弹窗 -->
  <view class="modal-overlay" wx:if="{{showTodoDetail}}" bindtap="hideTodoDetail">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">{{selectedTodo.title}}</text>
        <text class="modal-close" bindtap="hideTodoDetail">✕</text>
      </view>
      
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-item">
            <text class="detail-label">状态：</text>
            <text class="detail-value status {{selectedTodo.completed ? 'completed' : 'pending'}}">{{selectedTodo.completed ? '已完成' : '待完成'}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">优先级：</text>
            <view class="detail-value priority">
              <view class="priority-dot {{selectedTodo.priority}}"></view>
              <text>{{selectedTodo.priorityText}}</text>
            </view>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.description}}">
            <text class="detail-label">描述：</text>
            <text class="detail-value">{{selectedTodo.description}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.dueDate}}">
            <text class="detail-label">截止时间：</text>
            <text class="detail-value">{{selectedTodo.dueDateText}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.tags && selectedTodo.tags.length > 0}}">
            <text class="detail-label">标签：</text>
            <view class="detail-tags">
              <text class="detail-tag" wx:for="{{selectedTodo.tags}}" wx:key="*this">{{item}}</text>
            </view>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">创建时间：</text>
            <text class="detail-value">{{selectedTodo.createdAtText}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.completed && selectedTodo.completedAt}}">
            <text class="detail-label">完成时间：</text>
            <text class="detail-value">{{selectedTodo.completedAtText}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideTodoDetail">关闭</button>
        <button class="btn btn-primary" bindtap="editTodoFromDetail">编辑</button>
      </view>
    </view>
  </view>
</view>