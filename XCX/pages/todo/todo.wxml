<!--pages/todo/todo.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡åŒºåŸŸ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">æ€»è®¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.pending}}</text>
        <text class="stat-label">å¾…å®Œæˆ</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.completed}}</text>
        <text class="stat-label">å·²å®Œæˆ</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.overdue}}</text>
        <text class="stat-label">å·²é€¾æœŸ</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
  <view class="search-section">
    <view class="search-bar">
      <input class="search-input" placeholder="æœç´¢å¾…åŠäº‹é¡¹" value="{{searchText}}" bindinput="onSearchInput" />
      <text class="search-icon">ğŸ”</text>
    </view>
    
    <view class="filter-tabs">
      <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" bindtap="switchFilter" data-filter="all">
        <text>å…¨éƒ¨</text>
      </view>
      <view class="filter-tab {{currentFilter === 'pending' ? 'active' : ''}}" bindtap="switchFilter" data-filter="pending">
        <text>å¾…å®Œæˆ</text>
      </view>
      <view class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}" bindtap="switchFilter" data-filter="completed">
        <text>å·²å®Œæˆ</text>
      </view>
      <view class="filter-tab {{currentFilter === 'overdue' ? 'active' : ''}}" bindtap="switchFilter" data-filter="overdue">
        <text>å·²é€¾æœŸ</text>
      </view>
    </view>
    
    <view class="sort-options">
      <view class="sort-item {{currentSort === 'priority' ? 'active' : ''}}" bindtap="switchSort" data-sort="priority">
        <text>ä¼˜å…ˆçº§</text>
      </view>
      <view class="sort-item {{currentSort === 'dueDate' ? 'active' : ''}}" bindtap="switchSort" data-sort="dueDate">
        <text>æˆªæ­¢æ—¶é—´</text>
      </view>
      <view class="sort-item {{currentSort === 'createdAt' ? 'active' : ''}}" bindtap="switchSort" data-sort="createdAt">
        <text>åˆ›å»ºæ—¶é—´</text>
      </view>
    </view>
  </view>

  <!-- å¾…åŠåˆ—è¡¨ -->
  <view class="todo-list" wx:if="{{filteredTodos.length > 0}}">
    <view class="todo-item {{item.completed ? 'completed' : ''}} {{item.priority}}" wx:for="{{filteredTodos}}" wx:key="id">
      <!-- ä¼˜å…ˆçº§æŒ‡ç¤ºå™¨ -->
      <view class="priority-indicator {{item.priority}}"></view>
      
      <!-- å¤é€‰æ¡† -->
      <view class="todo-checkbox {{item.completed ? 'checked' : ''}}" bindtap="toggleTodo" data-id="{{item.id}}">
        <text class="checkbox-icon" wx:if="{{item.completed}}">âœ“</text>
      </view>
      
      <!-- å¾…åŠå†…å®¹ -->
      <view class="todo-content" bindtap="openTodoDetail" data-item="{{item}}">
        <text class="todo-title {{item.completed ? 'completed' : ''}}">{{item.title}}</text>
        <text class="todo-desc" wx:if="{{item.description}}">{{item.description}}</text>
        
        <!-- æ ‡ç­¾ -->
        <view class="todo-tags" wx:if="{{item.tags && item.tags.length > 0}}">
          <text class="todo-tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
        </view>
        
        <!-- æ—¶é—´ä¿¡æ¯ -->
        <view class="todo-meta">
          <text class="todo-time" wx:if="{{item.dueDate}}">
            ğŸ“… {{item.dueDateText}}
          </text>
          <text class="todo-created">åˆ›å»ºäº {{item.createdAtText}}</text>
        </view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="todo-actions">
        <view class="action-btn" bindtap="showTodoOptions" data-item="{{item}}">
          <text class="action-icon">â‹¯</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ“</text>
    <text class="empty-text">{{emptyText}}</text>
    <text class="empty-action" bindtap="createTodo" wx:if="{{currentFilter === 'all' || currentFilter === 'pending'}}">åˆ›å»ºç¬¬ä¸€ä¸ªå¾…åŠ</text>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab" bindtap="createTodo">
    <text class="fab-icon">+</text>
  </view>

  <!-- å¾…åŠåˆ›å»º/ç¼–è¾‘å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTodoModal}}" bindtap="hideTodoModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">{{editingTodo.id ? 'ç¼–è¾‘å¾…åŠ' : 'åˆ›å»ºå¾…åŠ'}}</text>
        <text class="modal-close" bindtap="hideTodoModal">âœ•</text>
      </view>
      
      <view class="modal-body">
        <!-- æ ‡é¢˜ -->
        <view class="input-group">
          <text class="input-label">æ ‡é¢˜ <text class="input-required">*</text></text>
          <input class="input" placeholder="è¯·è¾“å…¥å¾…åŠæ ‡é¢˜" value="{{editingTodo.title}}" bindinput="onTitleInput" />
        </view>
        
        <!-- æè¿° -->
        <view class="input-group">
          <text class="input-label">æè¿°</text>
          <textarea class="input textarea" placeholder="è¯·è¾“å…¥å¾…åŠæè¿°" value="{{editingTodo.description}}" bindinput="onDescInput"></textarea>
        </view>
        
        <!-- ä¼˜å…ˆçº§ -->
        <view class="input-group">
          <text class="input-label">ä¼˜å…ˆçº§</text>
          <view class="priority-selector">
            <view class="priority-option {{editingTodo.priority === 'low' ? 'active' : ''}}" bindtap="selectPriority" data-priority="low">
              <view class="priority-dot low"></view>
              <text>ä½</text>
            </view>
            <view class="priority-option {{editingTodo.priority === 'medium' ? 'active' : ''}}" bindtap="selectPriority" data-priority="medium">
              <view class="priority-dot medium"></view>
              <text>ä¸­</text>
            </view>
            <view class="priority-option {{editingTodo.priority === 'high' ? 'active' : ''}}" bindtap="selectPriority" data-priority="high">
              <view class="priority-dot high"></view>
              <text>é«˜</text>
            </view>
          </view>
        </view>
        
        <!-- æˆªæ­¢æ—¥æœŸ -->
        <view class="input-group">
          <text class="input-label">æˆªæ­¢æ—¥æœŸ</text>
          <picker mode="date" value="{{editingTodo.dueDate}}" bindchange="onDueDateChange">
            <view class="picker-input">
              <text class="picker-text {{editingTodo.dueDate ? '' : 'placeholder'}}">{{editingTodo.dueDate || 'é€‰æ‹©æˆªæ­¢æ—¥æœŸ'}}</text>
              <text class="picker-icon">ğŸ“…</text>
            </view>
          </picker>
        </view>
        
        <!-- æˆªæ­¢æ—¶é—´ -->
        <view class="input-group" wx:if="{{editingTodo.dueDate}}">
          <text class="input-label">æˆªæ­¢æ—¶é—´</text>
          <picker mode="time" value="{{editingTodo.dueTime}}" bindchange="onDueTimeChange">
            <view class="picker-input">
              <text class="picker-text {{editingTodo.dueTime ? '' : 'placeholder'}}">{{editingTodo.dueTime || 'é€‰æ‹©æˆªæ­¢æ—¶é—´'}}</text>
              <text class="picker-icon">â°</text>
            </view>
          </picker>
        </view>
        
        <!-- æ ‡ç­¾ -->
        <view class="input-group">
          <text class="input-label">æ ‡ç­¾</text>
          <view class="tag-input-container">
            <view class="selected-tags" wx:if="{{editingTodo.tags && editingTodo.tags.length > 0}}">
              <view class="selected-tag" wx:for="{{editingTodo.tags}}" wx:key="*this">
                <text>{{item}}</text>
                <text class="tag-remove" bindtap="removeTag" data-tag="{{item}}">Ã—</text>
              </view>
            </view>
            <view class="tag-input-row">
              <input class="tag-input" placeholder="æ·»åŠ æ ‡ç­¾" value="{{inputTag}}" bindinput="onTagInput" bindconfirm="addTag" />
              <button class="tag-add-btn" bindtap="addTag">æ·»åŠ </button>
            </view>
          </view>
        </view>
        
        <!-- æé†’è®¾ç½® -->
        <view class="input-group">
          <view class="switch-row">
            <text class="input-label">è®¾ç½®æé†’</text>
            <switch checked="{{editingTodo.reminder}}" bindchange="onReminderChange" />
          </view>
          <view class="reminder-options" wx:if="{{editingTodo.reminder}}">
            <picker mode="selector" range="{{reminderOptions}}" value="{{editingTodo.reminderIndex}}" bindchange="onReminderOptionChange">
              <view class="picker-input">
                <text class="picker-text">{{reminderOptions[editingTodo.reminderIndex] || 'é€‰æ‹©æé†’æ—¶é—´'}}</text>
                <text class="picker-icon">â°</text>
              </view>
            </picker>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideTodoModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="saveTodo">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- å¾…åŠæ“ä½œå¼¹çª— -->
  <view class="action-sheet" wx:if="{{showTodoOptions}}" bindtap="hideTodoOptions">
    <view class="action-sheet-content" catchtap="preventClose">
      <view class="action-sheet-header">
        <text class="action-sheet-title">{{selectedTodo.title}}</text>
        <text class="action-sheet-close" bindtap="hideTodoOptions">âœ•</text>
      </view>
      <view class="action-list">
        <view class="action-item" bindtap="editTodo">
          <text class="action-icon">âœï¸</text>
          <text class="action-text">ç¼–è¾‘</text>
        </view>
        <view class="action-item" bindtap="duplicateTodo">
          <text class="action-icon">ğŸ“‹</text>
          <text class="action-text">å¤åˆ¶</text>
        </view>
        <view class="action-item" bindtap="shareTodo">
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«</text>
        </view>
        <view class="action-item danger" bindtap="deleteTodo">
          <text class="action-icon">ğŸ—‘ï¸</text>
          <text class="action-text">åˆ é™¤</text>
        </view>
      </view>
      <view class="action-cancel" bindtap="hideTodoOptions">
        <text>å–æ¶ˆ</text>
      </view>
    </view>
  </view>

  <!-- å¾…åŠè¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTodoDetail}}" bindtap="hideTodoDetail">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">{{selectedTodo.title}}</text>
        <text class="modal-close" bindtap="hideTodoDetail">âœ•</text>
      </view>
      
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-item">
            <text class="detail-label">çŠ¶æ€ï¼š</text>
            <text class="detail-value status {{selectedTodo.completed ? 'completed' : 'pending'}}">{{selectedTodo.completed ? 'å·²å®Œæˆ' : 'å¾…å®Œæˆ'}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">ä¼˜å…ˆçº§ï¼š</text>
            <view class="detail-value priority">
              <view class="priority-dot {{selectedTodo.priority}}"></view>
              <text>{{selectedTodo.priorityText}}</text>
            </view>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.description}}">
            <text class="detail-label">æè¿°ï¼š</text>
            <text class="detail-value">{{selectedTodo.description}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.dueDate}}">
            <text class="detail-label">æˆªæ­¢æ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedTodo.dueDateText}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.tags && selectedTodo.tags.length > 0}}">
            <text class="detail-label">æ ‡ç­¾ï¼š</text>
            <view class="detail-tags">
              <text class="detail-tag" wx:for="{{selectedTodo.tags}}" wx:key="*this">{{item}}</text>
            </view>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedTodo.createdAtText}}</text>
          </view>
          
          <view class="detail-item" wx:if="{{selectedTodo.completed && selectedTodo.completedAt}}">
            <text class="detail-label">å®Œæˆæ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedTodo.completedAtText}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideTodoDetail">å…³é—­</button>
        <button class="btn btn-primary" bindtap="editTodoFromDetail">ç¼–è¾‘</button>
      </view>
    </view>
  </view>
</view>