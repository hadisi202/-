<!--pages/dashboard/dashboard.wxml-->
<view class="page">
  <!-- é¡¶éƒ¨æ¦‚è§ˆ -->
  <view class="overview-section">
    <view class="overview-header">
      <view class="overview-title">æ•°æ®æ¦‚è§ˆ</view>
      <view class="overview-date">{{currentDate}}</view>
    </view>
    
    <view class="overview-cards">
      <view class="overview-card">
        <view class="card-icon">ğŸ“‹</view>
        <view class="card-info">
          <view class="card-number">{{overview.totalTodos}}</view>
          <view class="card-label">æ€»å¾…åŠ</view>
        </view>
        <view class="card-trend {{overview.todoTrend >= 0 ? 'up' : 'down'}}">
          {{overview.todoTrend >= 0 ? 'â†—' : 'â†˜'}} {{Math.abs(overview.todoTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">ğŸ“„</view>
        <view class="card-info">
          <view class="card-number">{{overview.totalDocs}}</view>
          <view class="card-label">æ€»æ–‡æ¡£</view>
        </view>
        <view class="card-trend {{overview.docTrend >= 0 ? 'up' : 'down'}}">
          {{overview.docTrend >= 0 ? 'â†—' : 'â†˜'}} {{Math.abs(overview.docTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">ğŸ¯</view>
        <view class="card-info">
          <view class="card-number">{{overview.completionRate}}%</view>
          <view class="card-label">å®Œæˆç‡</view>
        </view>
        <view class="card-trend {{overview.completionTrend >= 0 ? 'up' : 'down'}}">
          {{overview.completionTrend >= 0 ? 'â†—' : 'â†˜'}} {{Math.abs(overview.completionTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">âš¡</view>
        <view class="card-info">
          <view class="card-number">{{overview.productivity}}</view>
          <view class="card-label">ç”Ÿäº§åŠ›</view>
        </view>
        <view class="card-trend {{overview.productivityTrend >= 0 ? 'up' : 'down'}}">
          {{overview.productivityTrend >= 0 ? 'â†—' : 'â†˜'}} {{Math.abs(overview.productivityTrend)}}%
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
  <view class="time-range-section">
    <scroll-view class="time-range-tabs" scroll-x>
      <view 
        class="time-range-tab {{currentTimeRange === 'today' ? 'active' : ''}}"
        data-range="today"
        bindtap="switchTimeRange"
      >
        ä»Šå¤©
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'week' ? 'active' : ''}}"
        data-range="week"
        bindtap="switchTimeRange"
      >
        æœ¬å‘¨
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'month' ? 'active' : ''}}"
        data-range="month"
        bindtap="switchTimeRange"
      >
        æœ¬æœˆ
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'quarter' ? 'active' : ''}}"
        data-range="quarter"
        bindtap="switchTimeRange"
      >
        æœ¬å­£åº¦
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'year' ? 'active' : ''}}"
        data-range="year"
        bindtap="switchTimeRange"
      >
        ä»Šå¹´
      </view>
    </scroll-view>
  </view>

  <!-- å›¾è¡¨åŒºåŸŸ -->
  <view class="charts-section">
    <!-- å¾…åŠå®Œæˆè¶‹åŠ¿ -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">å¾…åŠå®Œæˆè¶‹åŠ¿</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="todoTrendChart"
          id="todoTrendChart"
        ></canvas>
      </view>
    </view>
    
    <!-- å·¥ä½œæ•ˆç‡åˆ†æ -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">å·¥ä½œæ•ˆç‡åˆ†æ</view>
        <view class="chart-subtitle">æŒ‰ä¼˜å…ˆçº§åˆ†å¸ƒ</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="priorityChart"
          id="priorityChart"
        ></canvas>
      </view>
    </view>
    
    <!-- æ–‡æ¡£åˆ›å»ºç»Ÿè®¡ -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">æ–‡æ¡£åˆ›å»ºç»Ÿè®¡</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="docChart"
          id="docChart"
        ></canvas>
      </view>
    </view>
    
    <!-- ä¼šè®®æ—¶é—´åˆ†å¸ƒ -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">ä¼šè®®æ—¶é—´åˆ†å¸ƒ</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="meetingChart"
          id="meetingChart"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- è¯¦ç»†ç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="stats-header">
      <view class="stats-title">è¯¦ç»†ç»Ÿè®¡</view>
      <view class="stats-export" bindtap="exportData">
        <view class="export-icon">ğŸ“Š</view>
        <view class="export-text">å¯¼å‡º</view>
      </view>
    </view>
    
    <!-- å¾…åŠç»Ÿè®¡ -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="todo">
        <view class="category-title">
          <view class="category-icon">ğŸ“‹</view>
          <view class="category-name">å¾…åŠäº‹é¡¹</view>
        </view>
        <view class="category-toggle {{expandedCategories.todo ? 'expanded' : ''}}">
          â€º
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.todo}}">
        <view class="stat-item">
          <view class="stat-label">æ€»è®¡</view>
          <view class="stat-value">{{todoStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å·²å®Œæˆ</view>
          <view class="stat-value completed">{{todoStats.completed}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">è¿›è¡Œä¸­</view>
          <view class="stat-value pending">{{todoStats.pending}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å·²é€¾æœŸ</view>
          <view class="stat-value overdue">{{todoStats.overdue}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å¹³å‡å®Œæˆæ—¶é—´</view>
          <view class="stat-value">{{todoStats.avgCompletionTime}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">é«˜ä¼˜å…ˆçº§å æ¯”</view>
          <view class="stat-value">{{todoStats.highPriorityRate}}%</view>
        </view>
      </view>
    </view>
    
    <!-- æ–‡æ¡£ç»Ÿè®¡ -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="doc">
        <view class="category-title">
          <view class="category-icon">ğŸ“„</view>
          <view class="category-name">æ–‡æ¡£åä½œ</view>
        </view>
        <view class="category-toggle {{expandedCategories.doc ? 'expanded' : ''}}">
          â€º
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.doc}}">
        <view class="stat-item">
          <view class="stat-label">æ€»è®¡</view>
          <view class="stat-value">{{docStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ¬æœŸæ–°å¢</view>
          <view class="stat-value new">{{docStats.newDocs}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">ç¼–è¾‘æ¬¡æ•°</view>
          <view class="stat-value">{{docStats.editCount}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å…±äº«æ–‡æ¡£</view>
          <view class="stat-value">{{docStats.sharedDocs}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å¹³å‡å­—æ•°</view>
          <view class="stat-value">{{docStats.avgWordCount}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€æ´»è·ƒç±»å‹</view>
          <view class="stat-value">{{docStats.mostActiveType}}</view>
        </view>
      </view>
    </view>
    
    <!-- ä¼šè®®ç»Ÿè®¡ -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="meeting">
        <view class="category-title">
          <view class="category-icon">ğŸ¯</view>
          <view class="category-name">ä¼šè®®åŠ©æ‰‹</view>
        </view>
        <view class="category-toggle {{expandedCategories.meeting ? 'expanded' : ''}}">
          â€º
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.meeting}}">
        <view class="stat-item">
          <view class="stat-label">æ€»è®¡</view>
          <view class="stat-value">{{meetingStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å·²å®Œæˆ</view>
          <view class="stat-value completed">{{meetingStats.completed}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æ€»æ—¶é•¿</view>
          <view class="stat-value">{{meetingStats.totalDuration}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å¹³å‡æ—¶é•¿</view>
          <view class="stat-value">{{meetingStats.avgDuration}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å‚ä¼šäººæ•°</view>
          <view class="stat-value">{{meetingStats.totalAttendees}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">åœ¨çº¿ä¼šè®®å æ¯”</view>
          <view class="stat-value">{{meetingStats.onlineRate}}%</view>
        </view>
      </view>
    </view>
    
    <!-- è”ç³»äººç»Ÿè®¡ -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="contact">
        <view class="category-title">
          <view class="category-icon">ğŸ‘¥</view>
          <view class="category-name">é€šè®¯å½•</view>
        </view>
        <view class="category-toggle {{expandedCategories.contact ? 'expanded' : ''}}">
          â€º
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.contact}}">
        <view class="stat-item">
          <view class="stat-label">æ€»è”ç³»äºº</view>
          <view class="stat-value">{{contactStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ¬æœŸæ–°å¢</view>
          <view class="stat-value new">{{contactStats.newContacts}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">åˆ†ç»„æ•°é‡</view>
          <view class="stat-value">{{contactStats.groups}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æ”¶è—è”ç³»äºº</view>
          <view class="stat-value">{{contactStats.favorites}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€è¿‘è”ç³»</view>
          <view class="stat-value">{{contactStats.recentContacts}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">è”ç³»é¢‘ç‡</view>
          <view class="stat-value">{{contactStats.contactFrequency}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä½¿ç”¨ä¹ æƒ¯åˆ†æ -->
  <view class="habits-section">
    <view class="habits-header">
      <view class="habits-title">ä½¿ç”¨ä¹ æƒ¯åˆ†æ</view>
    </view>
    
    <view class="habits-grid">
      <view class="habit-item">
        <view class="habit-icon">ğŸ•</view>
        <view class="habit-info">
          <view class="habit-label">æœ€æ´»è·ƒæ—¶æ®µ</view>
          <view class="habit-value">{{habits.mostActiveTime}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">ğŸ“±</view>
        <view class="habit-info">
          <view class="habit-label">æ—¥å‡ä½¿ç”¨æ—¶é•¿</view>
          <view class="habit-value">{{habits.dailyUsage}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">ğŸ¯</view>
        <view class="habit-info">
          <view class="habit-label">æœ€å¸¸ç”¨åŠŸèƒ½</view>
          <view class="habit-value">{{habits.mostUsedFeature}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">ğŸ“ˆ</view>
        <view class="habit-info">
          <view class="habit-label">æ•ˆç‡æå‡</view>
          <view class="habit-value">{{habits.efficiencyImprovement}}%</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç›®æ ‡è®¾ç½® -->
  <view class="goals-section">
    <view class="goals-header">
      <view class="goals-title">ç›®æ ‡è®¾ç½®</view>
      <view class="goals-add" bindtap="addGoal">
        <view class="add-icon">+</view>
        <view class="add-text">æ·»åŠ ç›®æ ‡</view>
      </view>
    </view>
    
    <view class="goals-list">
      <view 
        class="goal-item"
        wx:for="{{goals}}"
        wx:key="id"
        data-goal="{{item}}"
        bindtap="openGoal"
      >
        <view class="goal-progress">
          <view class="progress-circle">
            <view class="progress-text">{{item.progress}}%</view>
          </view>
        </view>
        <view class="goal-info">
          <view class="goal-title">{{item.title}}</view>
          <view class="goal-desc">{{item.description}}</view>
          <view class="goal-deadline">æˆªæ­¢ï¼š{{item.deadlineText}}</view>
        </view>
        <view class="goal-status {{item.status}}">
          {{item.statusText}}
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-goals" wx:if="{{goals.length === 0}}">
      <view class="empty-icon">ğŸ¯</view>
      <view class="empty-text">è¿˜æ²¡æœ‰è®¾ç½®ç›®æ ‡</view>
      <view class="empty-action" bindtap="addGoal">è®¾ç½®ç¬¬ä¸€ä¸ªç›®æ ‡</view>
    </view>
  </view>
</view>

<!-- ç›®æ ‡è®¾ç½®å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showGoalModal}}" bindtap="hideGoalModal">
  <view class="modal-content goal-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">{{editingGoal.id ? 'ç¼–è¾‘ç›®æ ‡' : 'æ·»åŠ ç›®æ ‡'}}</view>
      <view class="modal-close" bindtap="hideGoalModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="form-item">
        <view class="form-label">ç›®æ ‡æ ‡é¢˜ *</view>
        <input 
          class="form-input"
          placeholder="è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜"
          value="{{editingGoal.title}}"
          bindinput="onGoalTitleInput"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">ç›®æ ‡æè¿°</view>
        <textarea 
          class="form-textarea"
          placeholder="æè¿°ä½ çš„ç›®æ ‡"
          value="{{editingGoal.description}}"
          bindinput="onGoalDescInput"
          maxlength="200"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">ç›®æ ‡ç±»å‹</view>
        <picker 
          class="form-picker"
          range="{{goalTypes}}"
          range-key="name"
          value="{{editingGoal.typeIndex}}"
          bindchange="onGoalTypeChange"
        >
          <view class="picker-text {{editingGoal.typeIndex === -1 ? 'placeholder' : ''}}">
            {{editingGoal.typeIndex === -1 ? 'é€‰æ‹©ç›®æ ‡ç±»å‹' : goalTypes[editingGoal.typeIndex].name}}
          </view>
          <view class="picker-arrow">â€º</view>
        </picker>
      </view>
      
      <view class="form-item">
        <view class="form-label">ç›®æ ‡æ•°å€¼</view>
        <input 
          class="form-input"
          placeholder="å¦‚ï¼šå®Œæˆ10ä¸ªå¾…åŠ"
          value="{{editingGoal.target}}"
          bindinput="onGoalTargetInput"
          type="number"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">æˆªæ­¢æ—¥æœŸ</view>
        <picker 
          class="form-picker"
          mode="date"
          value="{{editingGoal.deadline}}"
          bindchange="onGoalDeadlineChange"
        >
          <view class="picker-text {{!editingGoal.deadline ? 'placeholder' : ''}}">
            {{editingGoal.deadline || 'é€‰æ‹©æˆªæ­¢æ—¥æœŸ'}}
          </view>
          <view class="picker-arrow">â€º</view>
        </picker>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideGoalModal">å–æ¶ˆ</view>
      <view class="btn btn-primary" bindtap="saveGoal">ä¿å­˜</view>
    </view>
  </view>
</view>

<!-- ç›®æ ‡è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showGoalDetail}}" bindtap="hideGoalDetail">
  <view class="modal-content goal-detail-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">ç›®æ ‡è¯¦æƒ…</view>
      <view class="modal-close" bindtap="hideGoalDetail">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="goal-detail-header">
        <view class="goal-detail-progress">
          <view class="progress-circle large">
            <view class="progress-text">{{selectedGoal.progress}}%</view>
          </view>
        </view>
        <view class="goal-detail-info">
          <view class="goal-detail-title">{{selectedGoal.title}}</view>
          <view class="goal-detail-desc">{{selectedGoal.description}}</view>
        </view>
      </view>
      
      <view class="goal-detail-stats">
        <view class="detail-stat">
          <view class="stat-label">ç›®æ ‡æ•°å€¼</view>
          <view class="stat-value">{{selectedGoal.target}}</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">å½“å‰è¿›åº¦</view>
          <view class="stat-value">{{selectedGoal.current}}</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">å‰©ä½™å¤©æ•°</view>
          <view class="stat-value">{{selectedGoal.remainingDays}}å¤©</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">åˆ›å»ºæ—¶é—´</view>
          <view class="stat-value">{{selectedGoal.createdAtText}}</view>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideGoalDetail">å…³é—­</view>
      <view class="btn btn-primary" bindtap="editGoalFromDetail">ç¼–è¾‘</view>
    </view>
  </view>
</view>