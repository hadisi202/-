<!--pages/dashboard/dashboard.wxml-->
<view class="page">
  <!-- 顶部概览 -->
  <view class="overview-section">
    <view class="overview-header">
      <view class="overview-title">数据概览</view>
      <view class="overview-date">{{currentDate}}</view>
    </view>
    
    <view class="overview-cards">
      <view class="overview-card">
        <view class="card-icon">📋</view>
        <view class="card-info">
          <view class="card-number">{{overview.totalTodos}}</view>
          <view class="card-label">总待办</view>
        </view>
        <view class="card-trend {{overview.todoTrend >= 0 ? 'up' : 'down'}}">
          {{overview.todoTrend >= 0 ? '↗' : '↘'}} {{Math.abs(overview.todoTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">📄</view>
        <view class="card-info">
          <view class="card-number">{{overview.totalDocs}}</view>
          <view class="card-label">总文档</view>
        </view>
        <view class="card-trend {{overview.docTrend >= 0 ? 'up' : 'down'}}">
          {{overview.docTrend >= 0 ? '↗' : '↘'}} {{Math.abs(overview.docTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">🎯</view>
        <view class="card-info">
          <view class="card-number">{{overview.completionRate}}%</view>
          <view class="card-label">完成率</view>
        </view>
        <view class="card-trend {{overview.completionTrend >= 0 ? 'up' : 'down'}}">
          {{overview.completionTrend >= 0 ? '↗' : '↘'}} {{Math.abs(overview.completionTrend)}}%
        </view>
      </view>
      
      <view class="overview-card">
        <view class="card-icon">⚡</view>
        <view class="card-info">
          <view class="card-number">{{overview.productivity}}</view>
          <view class="card-label">生产力</view>
        </view>
        <view class="card-trend {{overview.productivityTrend >= 0 ? 'up' : 'down'}}">
          {{overview.productivityTrend >= 0 ? '↗' : '↘'}} {{Math.abs(overview.productivityTrend)}}%
        </view>
      </view>
    </view>
  </view>

  <!-- 时间范围选择 -->
  <view class="time-range-section">
    <scroll-view class="time-range-tabs" scroll-x>
      <view 
        class="time-range-tab {{currentTimeRange === 'today' ? 'active' : ''}}"
        data-range="today"
        bindtap="switchTimeRange"
      >
        今天
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'week' ? 'active' : ''}}"
        data-range="week"
        bindtap="switchTimeRange"
      >
        本周
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'month' ? 'active' : ''}}"
        data-range="month"
        bindtap="switchTimeRange"
      >
        本月
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'quarter' ? 'active' : ''}}"
        data-range="quarter"
        bindtap="switchTimeRange"
      >
        本季度
      </view>
      <view 
        class="time-range-tab {{currentTimeRange === 'year' ? 'active' : ''}}"
        data-range="year"
        bindtap="switchTimeRange"
      >
        今年
      </view>
    </scroll-view>
  </view>

  <!-- 图表区域 -->
  <view class="charts-section">
    <!-- 待办完成趋势 -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">待办完成趋势</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="todoTrendChart"
          id="todoTrendChart"
        ></canvas>
      </view>
    </view>
    
    <!-- 工作效率分析 -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">工作效率分析</view>
        <view class="chart-subtitle">按优先级分布</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="priorityChart"
          id="priorityChart"
        ></canvas>
      </view>
    </view>
    
    <!-- 文档创建统计 -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">文档创建统计</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="docChart"
          id="docChart"
        ></canvas>
      </view>
    </view>
    
    <!-- 会议时间分布 -->
    <view class="chart-card">
      <view class="chart-header">
        <view class="chart-title">会议时间分布</view>
        <view class="chart-subtitle">{{currentTimeRangeText}}</view>
      </view>
      <view class="chart-container">
        <canvas 
          class="chart-canvas"
          canvas-id="meetingChart"
          id="meetingChart"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- 详细统计 -->
  <view class="stats-section">
    <view class="stats-header">
      <view class="stats-title">详细统计</view>
      <view class="stats-export" bindtap="exportData">
        <view class="export-icon">📊</view>
        <view class="export-text">导出</view>
      </view>
    </view>
    
    <!-- 待办统计 -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="todo">
        <view class="category-title">
          <view class="category-icon">📋</view>
          <view class="category-name">待办事项</view>
        </view>
        <view class="category-toggle {{expandedCategories.todo ? 'expanded' : ''}}">
          ›
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.todo}}">
        <view class="stat-item">
          <view class="stat-label">总计</view>
          <view class="stat-value">{{todoStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">已完成</view>
          <view class="stat-value completed">{{todoStats.completed}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">进行中</view>
          <view class="stat-value pending">{{todoStats.pending}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">已逾期</view>
          <view class="stat-value overdue">{{todoStats.overdue}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">平均完成时间</view>
          <view class="stat-value">{{todoStats.avgCompletionTime}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">高优先级占比</view>
          <view class="stat-value">{{todoStats.highPriorityRate}}%</view>
        </view>
      </view>
    </view>
    
    <!-- 文档统计 -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="doc">
        <view class="category-title">
          <view class="category-icon">📄</view>
          <view class="category-name">文档协作</view>
        </view>
        <view class="category-toggle {{expandedCategories.doc ? 'expanded' : ''}}">
          ›
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.doc}}">
        <view class="stat-item">
          <view class="stat-label">总计</view>
          <view class="stat-value">{{docStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">本期新增</view>
          <view class="stat-value new">{{docStats.newDocs}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">编辑次数</view>
          <view class="stat-value">{{docStats.editCount}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">共享文档</view>
          <view class="stat-value">{{docStats.sharedDocs}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">平均字数</view>
          <view class="stat-value">{{docStats.avgWordCount}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">最活跃类型</view>
          <view class="stat-value">{{docStats.mostActiveType}}</view>
        </view>
      </view>
    </view>
    
    <!-- 会议统计 -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="meeting">
        <view class="category-title">
          <view class="category-icon">🎯</view>
          <view class="category-name">会议助手</view>
        </view>
        <view class="category-toggle {{expandedCategories.meeting ? 'expanded' : ''}}">
          ›
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.meeting}}">
        <view class="stat-item">
          <view class="stat-label">总计</view>
          <view class="stat-value">{{meetingStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">已完成</view>
          <view class="stat-value completed">{{meetingStats.completed}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">总时长</view>
          <view class="stat-value">{{meetingStats.totalDuration}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">平均时长</view>
          <view class="stat-value">{{meetingStats.avgDuration}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">参会人数</view>
          <view class="stat-value">{{meetingStats.totalAttendees}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">在线会议占比</view>
          <view class="stat-value">{{meetingStats.onlineRate}}%</view>
        </view>
      </view>
    </view>
    
    <!-- 联系人统计 -->
    <view class="stat-category">
      <view class="category-header" bindtap="toggleCategory" data-category="contact">
        <view class="category-title">
          <view class="category-icon">👥</view>
          <view class="category-name">通讯录</view>
        </view>
        <view class="category-toggle {{expandedCategories.contact ? 'expanded' : ''}}">
          ›
        </view>
      </view>
      
      <view class="category-content" wx:if="{{expandedCategories.contact}}">
        <view class="stat-item">
          <view class="stat-label">总联系人</view>
          <view class="stat-value">{{contactStats.total}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">本期新增</view>
          <view class="stat-value new">{{contactStats.newContacts}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">分组数量</view>
          <view class="stat-value">{{contactStats.groups}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">收藏联系人</view>
          <view class="stat-value">{{contactStats.favorites}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">最近联系</view>
          <view class="stat-value">{{contactStats.recentContacts}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">联系频率</view>
          <view class="stat-value">{{contactStats.contactFrequency}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 使用习惯分析 -->
  <view class="habits-section">
    <view class="habits-header">
      <view class="habits-title">使用习惯分析</view>
    </view>
    
    <view class="habits-grid">
      <view class="habit-item">
        <view class="habit-icon">🕐</view>
        <view class="habit-info">
          <view class="habit-label">最活跃时段</view>
          <view class="habit-value">{{habits.mostActiveTime}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">📱</view>
        <view class="habit-info">
          <view class="habit-label">日均使用时长</view>
          <view class="habit-value">{{habits.dailyUsage}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">🎯</view>
        <view class="habit-info">
          <view class="habit-label">最常用功能</view>
          <view class="habit-value">{{habits.mostUsedFeature}}</view>
        </view>
      </view>
      
      <view class="habit-item">
        <view class="habit-icon">📈</view>
        <view class="habit-info">
          <view class="habit-label">效率提升</view>
          <view class="habit-value">{{habits.efficiencyImprovement}}%</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 目标设置 -->
  <view class="goals-section">
    <view class="goals-header">
      <view class="goals-title">目标设置</view>
      <view class="goals-add" bindtap="addGoal">
        <view class="add-icon">+</view>
        <view class="add-text">添加目标</view>
      </view>
    </view>
    
    <view class="goals-list">
      <view 
        class="goal-item"
        wx:for="{{goals}}"
        wx:key="id"
        data-goal="{{item}}"
        bindtap="openGoal"
      >
        <view class="goal-progress">
          <view class="progress-circle">
            <view class="progress-text">{{item.progress}}%</view>
          </view>
        </view>
        <view class="goal-info">
          <view class="goal-title">{{item.title}}</view>
          <view class="goal-desc">{{item.description}}</view>
          <view class="goal-deadline">截止：{{item.deadlineText}}</view>
        </view>
        <view class="goal-status {{item.status}}">
          {{item.statusText}}
        </view>
      </view>
    </view>
    
    <!-- 空状态 -->
    <view class="empty-goals" wx:if="{{goals.length === 0}}">
      <view class="empty-icon">🎯</view>
      <view class="empty-text">还没有设置目标</view>
      <view class="empty-action" bindtap="addGoal">设置第一个目标</view>
    </view>
  </view>
</view>

<!-- 目标设置弹窗 -->
<view class="modal-overlay" wx:if="{{showGoalModal}}" bindtap="hideGoalModal">
  <view class="modal-content goal-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">{{editingGoal.id ? '编辑目标' : '添加目标'}}</view>
      <view class="modal-close" bindtap="hideGoalModal">×</view>
    </view>
    
    <view class="modal-body">
      <view class="form-item">
        <view class="form-label">目标标题 *</view>
        <input 
          class="form-input"
          placeholder="请输入目标标题"
          value="{{editingGoal.title}}"
          bindinput="onGoalTitleInput"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">目标描述</view>
        <textarea 
          class="form-textarea"
          placeholder="描述你的目标"
          value="{{editingGoal.description}}"
          bindinput="onGoalDescInput"
          maxlength="200"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">目标类型</view>
        <picker 
          class="form-picker"
          range="{{goalTypes}}"
          range-key="name"
          value="{{editingGoal.typeIndex}}"
          bindchange="onGoalTypeChange"
        >
          <view class="picker-text {{editingGoal.typeIndex === -1 ? 'placeholder' : ''}}">
            {{editingGoal.typeIndex === -1 ? '选择目标类型' : goalTypes[editingGoal.typeIndex].name}}
          </view>
          <view class="picker-arrow">›</view>
        </picker>
      </view>
      
      <view class="form-item">
        <view class="form-label">目标数值</view>
        <input 
          class="form-input"
          placeholder="如：完成10个待办"
          value="{{editingGoal.target}}"
          bindinput="onGoalTargetInput"
          type="number"
        />
      </view>
      
      <view class="form-item">
        <view class="form-label">截止日期</view>
        <picker 
          class="form-picker"
          mode="date"
          value="{{editingGoal.deadline}}"
          bindchange="onGoalDeadlineChange"
        >
          <view class="picker-text {{!editingGoal.deadline ? 'placeholder' : ''}}">
            {{editingGoal.deadline || '选择截止日期'}}
          </view>
          <view class="picker-arrow">›</view>
        </picker>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideGoalModal">取消</view>
      <view class="btn btn-primary" bindtap="saveGoal">保存</view>
    </view>
  </view>
</view>

<!-- 目标详情弹窗 -->
<view class="modal-overlay" wx:if="{{showGoalDetail}}" bindtap="hideGoalDetail">
  <view class="modal-content goal-detail-modal" catchtap="preventClose">
    <view class="modal-header">
      <view class="modal-title">目标详情</view>
      <view class="modal-close" bindtap="hideGoalDetail">×</view>
    </view>
    
    <view class="modal-body">
      <view class="goal-detail-header">
        <view class="goal-detail-progress">
          <view class="progress-circle large">
            <view class="progress-text">{{selectedGoal.progress}}%</view>
          </view>
        </view>
        <view class="goal-detail-info">
          <view class="goal-detail-title">{{selectedGoal.title}}</view>
          <view class="goal-detail-desc">{{selectedGoal.description}}</view>
        </view>
      </view>
      
      <view class="goal-detail-stats">
        <view class="detail-stat">
          <view class="stat-label">目标数值</view>
          <view class="stat-value">{{selectedGoal.target}}</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">当前进度</view>
          <view class="stat-value">{{selectedGoal.current}}</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">剩余天数</view>
          <view class="stat-value">{{selectedGoal.remainingDays}}天</view>
        </view>
        <view class="detail-stat">
          <view class="stat-label">创建时间</view>
          <view class="stat-value">{{selectedGoal.createdAtText}}</view>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="btn btn-secondary" bindtap="hideGoalDetail">关闭</view>
      <view class="btn btn-primary" bindtap="editGoalFromDetail">编辑</view>
    </view>
  </view>
</view>