<view class="container">
  <!-- 标题区域 -->
  <view class="header">
    <text class="title">哈迪斯 包装查询系统</text>
    <text class="subtitle">输入板件编码进行查询</text>
  </view>

  <!-- 查询区域 -->
  <view class="search-section">
    <view class="input-group">
      <input 
        class="search-input" 
        placeholder="请输入编码或扫码查询" 
        value="{{inputCode}}" 
        bindinput="onInputChange"
        confirm-type="search"
        bindconfirm="doSearch"
      />
      <button class="search-btn" bindtap="doSearch" disabled="{{!inputCode}}">
        查询
      </button>
      <button class="scan-btn" bindtap="scanCodeSearch">扫码</button>
      
      <!-- 连接诊断按钮已按要求移除 -->
    </view>
  </view>

  <!-- 隐形诊断按钮（固定在左上角，尺寸与查询按钮一致） -->
  <button class="search-btn diag-btn" bindtap="diagnoseConnection" aria-label="隐形诊断按钮"></button>

  <!-- 结果显示区域 -->
  <view class="result-section" wx:if="{{result}}">
    <view class="result-card">
      <view class="result-header">
        <text class="result-title">查询结果</text>
        <text class="result-code">{{result.code}}</text>
      </view>
      
      <view class="result-content">
        <!-- 基本信息 -->
        <view class="info-section">
          <view class="section-title">基本信息</view>
          <view class="info-row">
            <text class="label">名称：</text>
            <text class="value">{{result.name || '未知'}}</text>
          </view>
          
          <view class="info-row">
            <text class="label">类型：</text>
            <text class="value">{{result.type || '未知'}}</text>
          </view>

          <!-- 方案B：在包裹与托盘类型下隐藏易出现多值的字段 -->
          <block wx:if="{{result.type !== '包裹' && result.type !== '托盘'}}">
            <view class="info-row">
              <text class="label">订单号：</text>
              <text class="value">{{result.orderNumber || '未知'}}</text>
            </view>
            <view class="info-row">
              <text class="label">客户地址：</text>
              <text class="value">{{result.customerAddress || '未知'}}</text>
            </view>
            <view class="info-row">
              <text class="label">房间号：</text>
              <text class="value">{{result.roomNumber || '未知'}}</text>
            </view>
            <view class="info-row">
              <text class="label">柜号：</text>
              <text class="value">{{result.cabinetNumber || '未知'}}</text>
            </view>
            <view class="info-row">
              <text class="label">材质：</text>
              <text class="value material">{{result.material || '未知'}}</text>
            </view>
            <view class="info-row">
              <text class="label">尺寸：</text>
              <text class="value">{{result.finishedSize || '未知'}}</text>
            </view>
          </block>
        </view>

        <!-- 托盘信息（上移到包裹信息之前） -->
        <view class="info-section" wx:if="{{result.pallet}}">
          <view class="section-title">托盘信息</view>
          <view class="info-row">
            <text class="label">托盘编号：</text>
            <text class="value">{{result.pallet.code}}</text>
            <block wx:if="{{result.pallet.pallet_index !== null && result.pallet.pallet_index !== undefined}}">
              <text class="value badge green">第{{result.pallet.pallet_index}}个托盘</text>
            </block>
            <block wx:else>
              <text class="value badge muted">序号缺失</text>
            </block>
          </view>
          <view class="info-row" wx:if="{{result.pallet.pallet_index !== null && result.pallet.pallet_index !== undefined}}">
            <text class="label">第几个托盘：</text>
            <text class="value highlight">第{{result.pallet.pallet_index}}个托盘</text>
          </view>
          <view class="info-row" wx:if="{{result.packageCount !== undefined}}">
            <text class="label">包裹总数：</text>
            <text class="value">{{result.packageCount}}</text>
          </view>

          <!-- 包裹列表（当查询的是托盘时） -->
          <view class="list" wx:if="{{result.packages && result.packages.length}}">
            <view class="card" wx:for="{{result.packages}}" wx:key="packageNumber">
              <view class="card-header">
                <view class="chip primary">{{item.packageNumber}}</view>
                <view class="chip">{{item.orderNumber || '未知订单'}}</view>
                <!-- 新增：第几个包裹标签 -->
                <block wx:if="{{item.packageIndex !== null && item.packageIndex !== undefined}}">
                  <view class="chip">第{{item.packageIndex}}个包裹</view>
                </block>
                <block wx:else>
                  <view class="chip muted">序号缺失</view>
                </block>
              </view>
              <view class="card-body grid grid-2">
                <view class="field">
                  <text class="label">地址</text>
                  <text class="value">{{item.customerAddress || '未知'}}</text>
                </view>
                <view class="field" wx:if="{{item.componentCount !== undefined}}">
                  <text class="label">板件总数</text>
                  <text class="value">{{item.componentCount}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 包裹信息 -->
        <view class="info-section" wx:if="{{result.package}}">
          <view class="section-title">包裹信息</view>
          <view class="info-row">
            <text class="label">包裹编号：</text>
            <text class="value">{{result.package.code}}</text>
            <block wx:if="{{result.package.package_index !== null && result.package.package_index !== undefined}}">
              <text class="value badge green">第{{result.package.package_index}}个包裹</text>
            </block>
            <block wx:else>
              <text class="value badge muted">序号缺失</text>
            </block>
          </view>
          <view class="info-row" wx:if="{{result.package.package_index !== null && result.package.package_index !== undefined}}">
            <text class="label">第几个包裹：</text>
            <text class="value highlight">第{{result.package.package_index}}个包裹</text>
          </view>
          <view class="info-row" wx:if="{{result.componentCount !== undefined}}">
            <text class="label">板件总数：</text>
            <text class="value">{{result.componentCount}}</text>
          </view>

          <!-- 板件列表（当查询的是包裹时） -->
          <view class="list" wx:if="{{result.components && result.components.length}}">
            <view class="card" wx:for="{{result.components}}" wx:key="componentCode">
              <view class="card-header">
                <view class="chip">{{item.orderNumber || '未知订单'}}</view>
                <view class="chip primary">{{item.componentCode}}</view>
                <view class="chip">{{item.componentName || '未知板件名'}}</view>
              </view>
              <view class="card-body grid grid-2">
                <view class="field">
                  <text class="label">材质</text>
                  <text class="value">{{item.material || '未知'}}</text>
                </view>
                <view class="field">
                  <text class="label">尺寸</text>
                  <text class="value">{{item.finishedSize || '未知'}}</text>
                </view>
                <view class="field">
                  <text class="label">房间号</text>
                  <text class="value">{{item.roomNumber || '未知'}}</text>
                </view>
                <view class="field">
                  <text class="label">柜号</text>
                  <text class="value">{{item.cabinetNumber || '未知'}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 无结果提示 -->
  <view class="no-result" wx:if="{{searched && !result}}">
    <text class="no-result-text">未找到相关板件信息</text>
    <text class="no-result-tip">请检查编码是否正确</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <text class="loading-text">查询中...</text>
  </view>
</view>